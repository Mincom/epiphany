---
# Common Debian family specific tasks

- name: Disable timers for unattended upgrade, so that none will be triggered by the `date -s` call.
  shell: "systemctl disable --now {{item}}"
  with_items:
    - 'apt-daily.timer'
    - 'apt-daily-upgrade.timer'

- name: Reload systemctl daemon to apply the new changes
  raw: systemctl daemon-reload

- name: Purge unattended upgrades
  shell: "apt-get -y purge unattended-upgrades"
  register: task_status_out
  retries: 60
  delay: 10
  until: 'task_status_out.rc == 0'

- name: Display any process holding /var/lib/dpkg/lock
  shell: "lsof /var/lib/dpkg/lock"
  register: detect_process_dpkg_lock
  failed_when: false
  changed_when: false

- debug: var=detect_process_dpkg_lock
  when: 'not detect_process_dpkg_lock.failed'

- name: Detect and kill process still holding lock
  shell: |
    pstree
    for lock_file in /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/lib/apt/lists/lock /var/cache/apt/archives/lock; do
      PROC_ID=$(lsof $lock_file 2>/dev/null | grep -v COMMAND | awk '{print $2}')
      if [ ! -z "$PROC_ID" ]; then
        kill $PROC_ID
      fi
    done
  when: 'not detect_process_dpkg_lock.failed'
  register: kill_process_out

- debug: var=kill_process_out.stdout
  when: 'not detect_process_dpkg_lock.failed'

- name: Install selinux packages as prerequisite for SELinux module
  apt:
    name:
      - build-essential
      - python-selinux
    update_cache: yes
    state: present

- name: Install Debian family packages
  apt:
    name:
      - apt-transport-https
      - bash-completion
      - ca-certificates
      - curl
      - ebtables
      - ethtool
      - fping
      - htop
      - iftop
      - jq
      - logrotate
      - net-tools
      - netcat
      - openssl
      - python-setuptools
      - software-properties-common
      - sshpass
      - sysstat
      - tar
      - telnet
      - tmux
      - unzip
      - vim
    update_cache: yes
    state: present

- name: Append prompt to .profile
  lineinfile:
    path: /home/{{ admin_user.name }}/.profile
    line: source /etc/profile.d/operations.sh
